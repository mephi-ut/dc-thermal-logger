<table id='map2d'>
	<tr>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div id='AirConditioning0' class='AirConditioning'>
				{{template "Dashboard/_sensorGroup.html" dict "sensors" .sensors "groups" .groups "groupName" "AirConditioning0" }}
			</div>
		</td>
		<td>
			<div class='AirConditioning'> </div>
		</td>
		<td>
			<div id='AirConditioning1' class='AirConditioning'>
				{{template "Dashboard/_sensorGroup.html" dict "sensors" .sensors "groups" .groups "groupName" "AirConditioning1" }}
			</div>
		</td>
		<td>
			<div class='AirConditioning'> </div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
		<td>
			<div class='ClosedFloor'> </div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div id="ServerRack0" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack1" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack2" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack3" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack4" class='ServerRack'>
				{{template "Dashboard/_sensorGroup.html" dict "sensors" .sensors "groups" .groups "groupName" "ServerRack4" }}
			</div>
		</td>
		<td>
			<div id="ServerRack5" class='ServerRack'>
				{{template "Dashboard/_sensorGroup.html" dict "sensors" .sensors "groups" .groups "groupName" "ServerRack5" }}
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
		<td>
			<div class='OpenedFloor'>
			</div>
		</td>
	</tr>
	<tr class='rotate180'>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div id="ServerRack6" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack7" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack8" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack9" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack10" class='ServerRack'>
			</div>
		</td>
		<td>
			<div id="ServerRack11" class='ServerRack'>
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
	</tr>
	<tr class='rotate180'>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='AirConditioning'>
			</div>
		</td>
		<td>
			<div id='AirConditioning2' class='AirConditioning'>
				{{template "Dashboard/_sensorGroup.html" dict "sensors" .sensors "groups" .groups "groupName" "AirConditioning2" }}
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
		<td>
			<div class='ClosedFloor'>
			</div>
		</td>
	</tr>
</table>

<script>
	var sensors = {
	{{ range $sensorId,$sensorInfo := .sensors }}
		{{ $sensorId }}: {{$sensorInfo}},
	{{ end }}
		0:{}
	};
	var groups  = {{.groups}};

	function selectSensorsGroup(groupName) {
		window.location='/#selectSensorsGroup='+groupName;

		var group = groups[groupName];

		var container = $('#sensors ul');

		container.html('');

		for (var i = 0; i < group.SensorIds.length; i++) {
			var sensorId = group.SensorIds[i];
			var sensor   = sensors[sensorId];
			container.append("<li><a href='#' onclick='selectSensor("+sensorId+")'>"+sensor.Name+" ("+sensor.Value+")</a></li>");
		}

		selectSensor(group.DefaultSensorId);
	}

	var chartPrevRequest = null
	var updateChartTimeout = null;

	function selectSensor(sensorId, isUpdateOnly) {
		if (chartPrevRequest != null) {
			chartPrevRequest.abort();
			chartPrevRequest = null;
		}

		window.location='/#selectSensor='+sensorId;

		var aggregationType = parseInt($('input[name=aggregationType]:checked').val());

		currentSensorId = sensorId;
		chartPrevRequest = $.ajax({
			cache:		false,
			dataType:	'json',
			url:		'/HistoryRecords.json?order=date:DESC&limit='+$('#limit').val()+'&historyRecord.AggregationType='+aggregationType+'&historyRecord.SensorId='+sensorId,
			success:	function(data){
				chartPrevRequest = null;
				data.historyRecords.sort(function(a, b){return a.Date < b.Date ? -1 : a.Date > b.Date})
				chart.dataProvider = data.historyRecords;
				chart.ignoreZoomed = true;
				chart.validateData();
				if (!isUpdateOnly) {
					chart.zoomOut();
				}
				//try{chart.zoomToIndexes(Math.round(chart.dataProvider.length * 0.5), chart.dataProvider.length)}catch(e){}
			},
		});

		if (updateChartTimeout != null) {
			clearTimeout(updateChartTimeout);
			updateChartTimeout = null;
		}

		var updateIntervalSecs = 60;

		switch (aggregationType) {
			case 1:
				updateIntervalSecs=2;
				break;
			case 2:
				updateIntervalSecs=60;
				break;
			case 3:
				updateIntervalSecs=60*5;
				break;
			case 4:
				updateIntervalSecs=60*60;
				break;
			case 5:
				updateIntervalSecs=60*60*24;
				break;
			case 6:
				updateIntervalSecs=60*60*24*7;
				break;
		}

		updateChartTimeout = setTimeout(function() {
			selectSensor(sensorId, true);
		}, 1000 * updateIntervalSecs);
	}
</script>
